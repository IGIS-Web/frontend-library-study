# Tailwind CSS v4 빌드 플로우 정확한 순서

> "CSS 파싱 → Rust 스캔 → CSS 생성" 전체 흐름을 단계별로 정리

## 요약

당신의 이해가 **거의 정확**합니다! 정확한 순서는:

1. ✅ **TypeScript가 CSS 파일 파싱** (`@import "tailwindcss"` 처리)
2. ✅ **Rust가 프로젝트 전체 스캔** (클래스 추출)
3. ✅ **TypeScript가 CSS 생성** (클래스 → CSS 규칙)
4. ✅ **Rust가 CSS 최적화** (Minify, Autoprefixer)

---

## 전체 흐름 (시간 순서대로)

```
┌─────────────────────────────────────────────────────────────┐
│ 사용자 파일                                                  │
│                                                              │
│ src/index.css                    src/App.tsx                │
│ ─────────────────                ─────────────────          │
│ @import "tailwindcss"            export function App() {    │
│                                    return (                 │
│ .my-custom {                         <div className=        │
│   color: red;                          "flex gap-4"         │
│ }                                      >                    │
│                                      </div>                 │
│                                    )                        │
│                                  }                          │
└─────────────────────────────────────────────────────────────┘
                         ↓
                    Vite 빌드 시작
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 1: CSS 파일 감지 (JavaScript - Vite 플러그인)          │
│                                                              │
│ GET /src/index.css                                          │
│   ↓                                                          │
│ @tailwindcss/vite 플러그인 transform() 호출                 │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 2: CSS 파일 파싱 (TypeScript)                          │
│                                                              │
│ 입력 (index.css):                                           │
│   @import "tailwindcss";                                    │
│   .my-custom { color: red; }                                │
│                                                              │
│ TypeScript CSS Parser:                                      │
│   CSS.parse(content) // 문자열 → AST                        │
│                                                              │
│ AST 결과:                                                   │
│   [                                                          │
│     { kind: 'at-rule', name: '@import',                     │
│       params: '"tailwindcss"' },                            │
│     { kind: 'rule', selector: '.my-custom',                 │
│       nodes: [{ property: 'color', value: 'red' }] }        │
│   ]                                                          │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 3: @import "tailwindcss" 처리 (TypeScript)             │
│                                                              │
│ @import "tailwindcss" 발견!                                 │
│   ↓                                                          │
│ node_modules/tailwindcss/index.css 읽기                     │
│   ↓                                                          │
│ 내용:                                                        │
│   @theme {                                                  │
│     --color-blue-500: #3b82f6;                              │
│     --spacing-4: 1rem;                                      │
│   }                                                          │
│   @tailwind utilities;                                      │
│                                                              │
│ AST에 인라인:                                               │
│   [                                                          │
│     { kind: 'at-rule', name: '@theme', ... },               │
│     { kind: 'at-rule', name: '@tailwind',                   │
│       params: 'utilities' },                                │
│     { kind: 'rule', selector: '.my-custom', ... }           │
│   ]                                                          │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 4: Tailwind 전용 at-rule 처리 (TypeScript)            │
│                                                              │
│ @theme 수집:                                                │
│   theme.set('--color-blue-500', '#3b82f6')                  │
│   theme.set('--spacing-4', '1rem')                          │
│                                                              │
│ @tailwind utilities 위치 저장:                              │
│   utilitiesNode = { kind: 'at-rule', ... }                  │
│   (나중에 여기에 생성된 CSS 삽입)                           │
│                                                              │
│ Design System 구축:                                         │
│   designSystem.utilities.set('flex', ...)                   │
│   designSystem.utilities.set('gap', ...)                    │
│   designSystem.utilities.set('bg', ...)                     │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 5: Compiler 객체 생성 완료 (TypeScript)                │
│                                                              │
│ compiler = {                                                 │
│   sources: [{ base: '/project', pattern: '**/*' }],         │
│   theme: { ... },                                            │
│   designSystem: { ... },                                     │
│   build(candidates) { /* CSS 생성 함수 */ }                 │
│ }                                                            │
│                                                              │
│ ✅ CSS 파싱 완료! (하지만 아직 CSS 생성 안 함)              │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 6: Rust Scanner 생성 (JavaScript → Rust)              │
│                                                              │
│ JavaScript:                                                  │
│   scanner = new Scanner({                                   │
│     sources: [{ base: '/project', pattern: '**/*' }]        │
│   })                                                         │
│                                                              │
│ Rust:                                                        │
│   Scanner {                                                  │
│     walker: WalkBuilder::new("/project"),                   │
│     candidates: HashSet::new(),                             │
│     files: Vec::new()                                        │
│   }                                                          │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 7: 프로젝트 전체 스캔 (Rust)                           │
│                                                              │
│ scanner.scan()                                               │
│   ↓                                                          │
│ 1. 파일 시스템 탐색:                                        │
│    /project/src/App.tsx       ✓                             │
│    /project/src/Button.tsx    ✓                             │
│    /project/node_modules/...  ✗ (.gitignore)                │
│                                                              │
│ 2. 파일 읽기 (병렬):                                        │
│    Thread 1: Read App.tsx                                   │
│    Thread 2: Read Button.tsx                                │
│                                                              │
│ 3. className 추출 (상태 머신):                              │
│    App.tsx:                                                 │
│      className="flex gap-4"                                 │
│      → ["flex", "gap-4"]                                    │
│                                                              │
│    Button.tsx:                                              │
│      className="px-4 py-2 bg-blue-500"                      │
│      → ["px-4", "py-2", "bg-blue-500"]                      │
│                                                              │
│ 4. 중복 제거 및 정렬:                                       │
│    → ["bg-blue-500", "flex", "gap-4", "px-4", "py-2"]       │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 8: 후보 클래스 반환 (Rust → JavaScript)                │
│                                                              │
│ Rust:                                                        │
│   Vec<String>: ["bg-blue-500", "flex", "gap-4", ...]        │
│                                                              │
│ JavaScript:                                                  │
│   candidates: string[] = scanner.scan()                     │
│   // ["bg-blue-500", "flex", "gap-4", "px-4", "py-2"]       │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 9: CSS 생성 (TypeScript)                               │
│                                                              │
│ compiler.build(candidates)                                   │
│   ↓                                                          │
│ 각 후보를 파싱:                                             │
│   "flex"                                                     │
│   → { kind: 'static', root: 'flex' }                        │
│   → designSystem.compileAstNodes(...)                       │
│   → { kind: 'rule', selector: '.flex',                      │
│       nodes: [{ property: 'display', value: 'flex' }] }     │
│                                                              │
│   "bg-blue-500"                                             │
│   → { kind: 'functional', root: 'bg', value: 'blue-500' }   │
│   → theme.resolve('colors.blue.500') → '#3b82f6'            │
│   → { kind: 'rule', selector: '.bg-blue-500',               │
│       nodes: [{ property: 'background-color',               │
│                 value: 'rgb(59 130 246)' }] }               │
│                                                              │
│ AST 업데이트:                                               │
│   @tailwind utilities 위치에 생성된 규칙 삽입!              │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 10: AST → CSS 문자열 변환 (TypeScript)                 │
│                                                              │
│ AST:                                                         │
│   [                                                          │
│     { kind: 'at-rule', name: '@theme', ... },               │
│     { kind: 'rule', selector: '.flex', ... },               │
│     { kind: 'rule', selector: '.gap-4', ... },              │
│     { kind: 'rule', selector: '.bg-blue-500', ... },        │
│     { kind: 'rule', selector: '.my-custom', ... }           │
│   ]                                                          │
│                                                              │
│ toCss(AST):                                                  │
│   :root {                                                    │
│     --color-blue-500: #3b82f6;                              │
│     --spacing-4: 1rem;                                      │
│   }                                                          │
│                                                              │
│   .flex { display: flex; }                                  │
│   .gap-4 { gap: 1rem; }                                     │
│   .bg-blue-500 { background-color: rgb(59 130 246); }       │
│                                                              │
│   .my-custom { color: red; }                                │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 11: CSS 최적화 (Rust - LightningCSS)                  │
│                                                              │
│ JavaScript:                                                  │
│   optimize(css, { minify: true })                           │
│                                                              │
│ Rust (LightningCSS):                                         │
│   - CSS Nesting 변환                                        │
│   - Vendor prefix 추가 (-webkit-, -moz-)                    │
│   - Minify (공백 제거)                                      │
│                                                              │
│ 결과:                                                        │
│   :root{--color-blue-500:#3b82f6;--spacing-4:1rem}          │
│   .flex{display:flex}                                        │
│   .gap-4{gap:1rem}                                           │
│   .bg-blue-500{background-color:rgb(59 130 246)}            │
│   .my-custom{color:red}                                      │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 12: 브라우저로 전송 (Vite)                             │
│                                                              │
│ HTTP Response:                                               │
│   Content-Type: text/css                                    │
│                                                              │
│   :root{--color-blue-500:#3b82f6}                           │
│   .flex{display:flex}                                        │
│   .gap-4{gap:1rem}                                           │
│   .bg-blue-500{background-color:rgb(59 130 246)}            │
│   .my-custom{color:red}                                      │
└─────────────────────────────────────────────────────────────┘
                         ↓
                    브라우저 렌더링 완료! 🎉
```

---

## 핵심 포인트 정리

### 1. CSS 파싱이 먼저 (TypeScript)

**이유:**
- `@import "tailwindcss"` 해석 필요
- `@theme` 수집 필요
- `@tailwind utilities` 위치 파악 필요
- Design System 구축 필요

**결과:**
- Theme 변수들 (--color-blue-500, etc.)
- 유틸리티 정의 (flex, gap, bg, etc.)
- CSS 생성 준비 완료

### 2. Rust 스캔이 중간 (Rust)

**입력:**
- `sources: [{ base: '/project', pattern: '**/*' }]`

**처리:**
1. 파일 시스템 탐색 (WalkDir)
2. 파일 읽기 (병렬)
3. className 추출 (상태 머신)

**출력:**
- `["bg-blue-500", "flex", "gap-4", "px-4", "py-2"]`

### 3. CSS 생성이 마지막 (TypeScript)

**입력:**
- 후보 클래스: `["flex", "bg-blue-500", ...]`
- Design System (Step 1에서 준비)

**처리:**
1. 각 후보 파싱 (`flex` → `{ kind: 'static', root: 'flex' }`)
2. CSS 규칙 생성 (`{ selector: '.flex', ... }`)
3. AST 업데이트 (`@tailwind utilities` 위치에 삽입)
4. AST → CSS 문자열

**출력:**
- 완성된 CSS 문자열

### 4. CSS 최적화가 진짜 마지막 (Rust)

**입력:**
- 생성된 CSS (읽기 쉬운 형식)

**처리:**
- Minify
- Autoprefixer
- Nesting 변환

**출력:**
- 최적화된 CSS (압축된 형식)

---

## 왜 이 순서인가?

### 1. CSS 파싱이 먼저여야 하는 이유

```typescript
// ❌ 순서를 바꾸면 안 되는 이유

// Rust 스캔부터 하면?
let candidates = scanner.scan()  // ["flex", "bg-blue-500"]

// 하지만...
// - theme 변수가 없음! (--color-blue-500 모름)
// - 유틸리티 정의가 없음! (flex가 뭔지 모름)
// - CSS 생성 불가능!

// ✅ 올바른 순서
// 1. CSS 파싱 → theme, utilities 준비
// 2. Rust 스캔 → 후보 클래스 추출
// 3. CSS 생성 → theme + utilities + 후보 = CSS
```

### 2. Rust 스캔이 중간이어야 하는 이유

```typescript
// ❌ CSS 생성 후에 스캔하면?

// 1. CSS 파싱
let compiler = compile(css)

// 2. CSS 생성 (후보 없이?)
compiler.build([])  // 빈 배열! 아무것도 생성 안 됨

// 3. Rust 스캔 (너무 늦음)
let candidates = scanner.scan()  // 이미 CSS 생성 끝남!

// ✅ 올바른 순서
// 1. CSS 파싱 → 준비
// 2. Rust 스캔 → 후보 수집
// 3. CSS 생성 → 후보를 CSS로 변환
```

---

## 간단 요약

### 당신의 이해 (거의 맞음!)

> CSS 파일들을 tailwind 파싱 형식으로 변경 → Rust로 클래스 감지/추출 → 다시 JS가 CSS로 변경

### 더 정확한 표현

```
1. TypeScript: CSS 파싱
   "@import tailwindcss" → theme 변수 + 유틸리티 정의

2. Rust: 프로젝트 스캔
   모든 파일 → className 추출 → ["flex", "bg-blue-500", ...]

3. TypeScript: CSS 생성
   후보 + theme + 유틸리티 → CSS 규칙

4. Rust: CSS 최적화
   CSS → Minify + Autoprefixer → 최종 CSS
```

### 비유로 설명

```
식당을 운영한다고 생각하면:

1. TypeScript (CSS 파싱):
   - 레시피 책 읽기 (@import "tailwindcss")
   - 재료 준비 (theme 변수)
   - 조리 도구 준비 (유틸리티 정의)

2. Rust (스캔):
   - 손님 주문 받기 (파일 스캔)
   - 주문서 정리 (className 추출)
   - ["피자", "파스타", "샐러드"]

3. TypeScript (CSS 생성):
   - 주문대로 요리 (후보 → CSS 변환)
   - 재료 + 레시피 → 완성된 요리

4. Rust (최적화):
   - 플레이팅 (Minify)
   - 장식 추가 (Autoprefixer)
   - 서빙!
```

---

## 실제 코드로 보는 순서

```typescript
// packages/@tailwindcss-vite/src/index.ts

async transform(src, id) {
  // Step 1-4: CSS 파싱 (TypeScript)
  this.compiler = await compile(src, {
    from: id,
    // @import 처리, @theme 수집, Design System 구축
  })

  // Step 5-8: Rust 스캔
  this.scanner = new Scanner({ sources })
  let candidates = this.scanner.scan()

  // Step 9-10: CSS 생성 (TypeScript)
  let css = this.compiler.build(candidates)

  // Step 11: CSS 최적화 (Rust)
  let optimized = optimize(css, { minify: true })

  return { code: optimized }
}
```

완벽하게 이해하셨습니다! 🎯