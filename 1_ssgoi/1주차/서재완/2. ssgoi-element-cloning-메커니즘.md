# SSGOI Element Cloning ë©”ì»¤ë‹ˆì¦˜: React Router ì–¸ë§ˆìš´íŠ¸ ì‹œ ì• ë‹ˆë©”ì´ì…˜ì´ ê°€ëŠ¥í•œ ì´ìœ 

## í•µì‹¬ ì§ˆë¬¸

**"React Routerì—ì„œ í˜ì´ì§€ê°€ ì–¸ë§ˆìš´íŠ¸ë˜ë©´ DOM ìš”ì†Œê°€ ì‚¬ë¼ì§€ëŠ”ë°, ì–´ë–»ê²Œ ì´ì „ í˜ì´ì§€ì˜ ì• ë‹ˆë©”ì´ì…˜ì´ ê°€ëŠ¥í• ê¹Œ?"**

ë‹µ: **Element Cloning (ìš”ì†Œ ë³µì œ)** - Reactì˜ ref cleanup íƒ€ì´ë°ì„ ì´ìš©í•œ ì˜ë¦¬í•œ í•´ê²°ì±…

## 1. React ì»´í¬ë„ŒíŠ¸ ë¼ì´í”„ì‚¬ì´í´ê³¼ SSGOI ê°œì… ì‹œì 

### React Routerì˜ ì¼ë°˜ì ì¸ í˜ì´ì§€ ì „í™˜ ê³¼ì •
```
1. ì‚¬ìš©ìê°€ ìƒˆë¡œìš´ ë¼ìš°íŠ¸ë¡œ ì´ë™ (ì˜ˆ: "/" â†’ "/about")
2. React Router: ì´ì „ ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ê³¼ì • ì‹œì‘
3. React: ref cleanup í•¨ìˆ˜ë“¤ ì‹¤í–‰ â† ğŸ”¥ SSGOIê°€ ê°œì…í•˜ëŠ” ì‹œì !
4. React: DOMì—ì„œ ìš”ì†Œë“¤ ì™„ì „ ì œê±°
5. React Router: ìƒˆë¡œìš´ ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œì‘
6. React: ìƒˆ í˜ì´ì§€ DOM ìš”ì†Œë“¤ ìƒì„±
```

### SSGOIì˜ ê°œì… ì „ëµ
SSGOIëŠ” **3ë²ˆ ì‹œì  (ref cleanup)**ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤:
- âœ… DOM ìš”ì†Œê°€ ì•„ì§ ì‚´ì•„ìˆìŒ
- âœ… ì™„ì „í•œ ë³µì œ ê°€ëŠ¥
- âœ… React ì œê±° í”„ë¡œì„¸ìŠ¤ë¥¼ ë°©í•´í•˜ì§€ ì•ŠìŒ

## 2. Element Cloning ë©”ì»¤ë‹ˆì¦˜ ìƒì„¸ ë¶„ì„

### 2.1 SsgoiTransitionì˜ ref cleanup í•¨ìˆ˜

`packages/react/src/lib/ssgoi-transition.tsx:11`:
```typescript
export const SsgoiTransition = ({children, id}: {children: ReactNode; id: string}) => {
    const getTransition = useSsgoi();

    return (
        <div ref={transition(getTransition(id))} data-ssgoi-transition={id}>
            {children}
        </div>
    );
};
```

### 2.2 transition í•¨ìˆ˜ì˜ cleanup ë°˜í™˜

`packages/core/src/lib/create-transition-callback.ts:129-140`:
```typescript
return (element: HTMLElement | null) => {
  if (!element) return;
  
  // ë¶€ëª¨ ì°¸ì¡° ì €ì¥ (ë³µì œë³¸ ì‚½ì…ìš©)
  parentRef = element.parentElement;
  nextSiblingRef = element.nextElementSibling;

  runEntrance(element); // IN ì• ë‹ˆë©”ì´ì…˜ ì¤€ë¹„

  return () => {  // ğŸ”¥ React ref cleanup í•¨ìˆ˜
    // Reactê°€ ì›ë³¸ì„ ì œê±°í•˜ê¸° ì§ì „ì— ë³µì œ!
    const cloned = element.cloneNode(true) as HTMLElement;
    runExitTransition(cloned); // ë³µì œë³¸ìœ¼ë¡œ OUT ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
  };
};
```

**í•µì‹¬ í¬ì¸íŠ¸:**
- `cloneNode(true)`: ìš”ì†Œì™€ ëª¨ë“  í•˜ìœ„ ìš”ì†Œ ì™„ì „ ë³µì œ
- ì›ë³¸ ìš”ì†Œê°€ ì•„ì§ DOMì— ìˆì„ ë•Œ ë³µì œ ì‹¤í–‰
- ë³µì œ í›„ ì¦‰ì‹œ OUT ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘

### 2.3 ë³µì œë³¸ DOM ì‚½ì…ê³¼ ì• ë‹ˆë©”ì´ì…˜

`packages/core/src/lib/create-transition-callback.ts:74-127`:
```typescript
const runExitTransition = async (element: HTMLElement) => {
  currentClone = element; // ë³µì œëœ ìš”ì†Œ ì €ì¥

  const transition = getTransition();
  const configs: TransitionConfigs<TAnimationValue> = {
    in: transition.in && Promise.resolve(transition.in(element)),
    out: transition.out && Promise.resolve(transition.out(element)),
  };

  const setup = await strategy.runOut(configs);
  setup.config.prepare?.(element); // prepareOutgoing ì‹¤í–‰

  insertClone(); // ğŸ”¥ ë³µì œë³¸ì„ DOMì— ë‹¤ì‹œ ì‚½ì…!

  // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
  const animator = Animator.fromState(setup.state, {
    from: setup.from, // 1 (ì™„ì „íˆ ë³´ì„)
    to: setup.to,     // 0 (ì™„ì „íˆ ì‚¬ë¼ì§)
    spring: setup.config.spring,
    onUpdate: setup.config.tick, // opacity ë³€ê²½
    onComplete: () => {
      if (currentClone) {
        currentClone.remove(); // ğŸ”¥ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ë³µì œë³¸ ì œê±°
        currentClone = null;
      }
      currentAnimation = null;
    },
  });

  animator.forward(); // ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
};
```

### 2.4 insertClone í•¨ìˆ˜

`packages/core/src/lib/create-transition-callback.ts:118-127`:
```typescript
function insertClone() {
  if (!parentRef || !currentClone) return;

  // ì›ë˜ ìœ„ì¹˜ì— ë³µì œë³¸ ì‚½ì…
  if (nextSiblingRef && parentRef.contains(nextSiblingRef)) {
    parentRef.insertBefore(currentClone, nextSiblingRef);
  } else {
    parentRef.appendChild(currentClone);
  }
}
```

## 3. ì‹¤ì œ DOM ìƒíƒœ ë³€í™” íƒ€ì„ë¼ì¸

### ì´ˆê¸° ìƒíƒœ: "/" í˜ì´ì§€
```html
<div id="root">
  <div ref={transition} data-ssgoi-transition="/">
    <h1>Home Page</h1>
    <p>Welcome to home!</p>
  </div>
</div>
```

### Phase 1: React Router ì–¸ë§ˆìš´íŠ¸ ì‹œì‘ + SSGOI ë³µì œ
```html
<div id="root">
  <!-- ì›ë³¸: Reactê°€ ê³§ ì œê±°í•  ì˜ˆì • -->
  <div ref={transition} data-ssgoi-transition="/">
    <h1>Home Page</h1>
    <p>Welcome to home!</p>
  </div>
  
  <!-- ë³µì œë³¸: SSGOIê°€ ìƒì„± (ì•„ì§ ë³´ì´ì§€ ì•ŠìŒ) -->
  <div style="opacity: 1; position: absolute;">
    <h1>Home Page</h1>
    <p>Welcome to home!</p>
  </div>
</div>
```

### Phase 2: React ì–¸ë§ˆìš´íŠ¸ ì™„ë£Œ + "/about" ë§ˆìš´íŠ¸ ì‹œì‘
```html
<div id="root">
  <!-- ì›ë³¸ ì œê±°ë¨ -->
  
  <!-- ë³µì œë³¸: fade out ì• ë‹ˆë©”ì´ì…˜ ì¤‘ -->
  <div style="opacity: 0.7; position: absolute;">
    <h1>Home Page</h1>
    <p>Welcome to home!</p>
  </div>
  
  <!-- ìƒˆ í˜ì´ì§€: fade in ì• ë‹ˆë©”ì´ì…˜ ì¤‘ -->
  <div ref={transition} data-ssgoi-transition="/about" style="opacity: 0.3;">
    <h1>About Page</h1>
    <p>Learn more about us!</p>
  </div>
</div>
```

### Phase 3: ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰ ì¤‘
```html
<div id="root">
  <!-- ë³µì œë³¸: ê³„ì† fade out -->
  <div style="opacity: 0.3; position: absolute;">
    <h1>Home Page</h1>
    <p>Welcome to home!</p>
  </div>
  
  <!-- ìƒˆ í˜ì´ì§€: ê³„ì† fade in -->
  <div ref={transition} data-ssgoi-transition="/about" style="opacity: 0.7;">
    <h1>About Page</h1>
    <p>Learn more about us!</p>
  </div>
</div>
```

### Phase 4: ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ
```html
<div id="root">
  <!-- ë³µì œë³¸ ì™„ì „ ì œê±°ë¨ -->
  
  <!-- ìƒˆ í˜ì´ì§€ë§Œ ë‚¨ìŒ -->
  <div ref={transition} data-ssgoi-transition="/about" style="opacity: 1;">
    <h1>About Page</h1>
    <p>Learn more about us!</p>
  </div>
</div>
```

## 4. fade ì• ë‹ˆë©”ì´ì…˜ì˜ êµ¬ì²´ì  ë™ì‘

### OUT ì• ë‹ˆë©”ì´ì…˜ (ë³µì œë³¸)
```typescript
// fade out transition
out: (element) => ({
  spring: { stiffness: 300, damping: 30 },
  tick: (progress) => {
    element.style.opacity = progress.toString(); // 1 â†’ 0
  },
  prepare: prepareOutgoing, // position: absolute ë“± ì„¤ì •
}),
```

### IN ì• ë‹ˆë©”ì´ì…˜ (ìƒˆ í˜ì´ì§€)
```typescript
// fade in transition  
in: (element) => ({
  spring: { stiffness: 300, damping: 30 },
  tick: (progress) => {
    element.style.opacity = progress.toString(); // 0 â†’ 1
  },
}),
```

### ë™ì‹œ ì‹¤í–‰ ê²°ê³¼
- **ë³µì œëœ "/" í˜ì´ì§€**: opacity 1.0 â†’ 0.0 (ì„œì„œíˆ ì‚¬ë¼ì§)
- **ìƒˆë¡œìš´ "/about" í˜ì´ì§€**: opacity 0.0 â†’ 1.0 (ì„œì„œíˆ ë‚˜íƒ€ë‚¨)
- **ìŠ¤í”„ë§ ë¬¼ë¦¬í•™**: ìì—°ìŠ¤ëŸ¬ìš´ easingìœ¼ë¡œ ë¶€ë“œëŸ¬ìš´ ì „í™˜

## 5. prepareOutgoing í•¨ìˆ˜ì˜ ì—­í• 

`packages/core/src/lib/utils.ts`:
```typescript
export const prepareOutgoing = (element: HTMLElement) => {
  // ë³µì œë³¸ì´ ì›ë³¸ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ absolute positioning
  element.style.position = "absolute";
  element.style.top = "0";
  element.style.left = "0";
  element.style.width = "100%";
  element.style.height = "100%";
  element.style.zIndex = "1000"; // ìœ„ì— í‘œì‹œ
};
```

**ëª©ì :**
- ë³µì œë³¸ì´ ìƒˆ í˜ì´ì§€ì™€ ë ˆì´ì•„ì›ƒ ê°„ì„­ ë°©ì§€
- ì •í™•í•œ ìœ„ì¹˜ì—ì„œ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
- z-indexë¡œ ë ˆì´ì–´ ìˆœì„œ ë³´ì¥

## 6. ë©”ëª¨ë¦¬ ê´€ë¦¬ì™€ ì •ë¦¬

### ìë™ ì •ë¦¬ ë©”ì»¤ë‹ˆì¦˜
```typescript
onComplete: () => {
  setup.config?.onEnd?.();
  if (currentClone) {
    currentClone.remove(); // DOMì—ì„œ ë³µì œë³¸ ì™„ì „ ì œê±°
    currentClone = null;   // ë©”ëª¨ë¦¬ ì°¸ì¡° í•´ì œ
  }
  currentAnimation = null; // ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ì´ˆê¸°í™”
  options?.onCleanupEnd?.(); // ì¶”ê°€ ì •ë¦¬ ì‘ì—…
},
```

### ì •ë¦¬ ë³´ì¥
- ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ ì‹œ ìë™ ì •ë¦¬
- ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
- DOM ì˜¤ì—¼ ë°©ì§€

## 7. ì™œ ì´ ë°©ì‹ì´ íš¨ê³¼ì ì¸ê°€?

### ì¥ì 
1. **ì™„ë²½í•œ ë³´ì¡´**: ì‚¬ë¼ì§€ëŠ” í˜ì´ì§€ì˜ ëª¨ë“  ìƒíƒœ ë³´ì¡´
2. **ìì—°ìŠ¤ëŸ¬ìš´ ì „í™˜**: ì§„ì§œ í˜ì´ì§€ê°€ ì‚¬ë¼ì§€ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì„
3. **React ë¹„ì¹¨ìŠµì **: React Router ë™ì‘ ë°©í•´ ì—†ìŒ
4. **ë©”ëª¨ë¦¬ íš¨ìœ¨**: ì• ë‹ˆë©”ì´ì…˜ í›„ ì¦‰ì‹œ ì •ë¦¬
5. **íƒ€ì´ë° ì™„ë²½**: ref cleanup ì‹œì  í™œìš©

### í•´ê²°í•˜ëŠ” ë¬¸ì œë“¤
- âŒ í˜ì´ì§€ ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì‚¬ë¼ì§/ë‚˜íƒ€ë‚¨
- âŒ ì–´ìƒ‰í•œ í™”ë©´ ê¹œë¹¡ì„
- âŒ ë„¤ì´í‹°ë¸Œ ì•± ëŒ€ë¹„ ë–¨ì–´ì§€ëŠ” UX
- âœ… ë¶€ë“œëŸ½ê³  ìì—°ìŠ¤ëŸ¬ìš´ í˜ì´ì§€ ì „í™˜

## 8. ë‹¤ë¥¸ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ì—ì„œì˜ í™œìš©

### hero ì „í™˜ì—ì„œì˜ ë³µì œ
```typescript
// hero ì „í™˜ì—ì„œë„ ê°™ì€ ì›ë¦¬ ì ìš©
out: async (element) => {
  return {
    onStart: () => {
      fromNode = element; // ë³µì œë³¸ì„ from ê¸°ì¤€ìœ¼ë¡œ ì €ì¥
      if (resolver) {
        resolver(true); // IN ì• ë‹ˆë©”ì´ì…˜ì— ì‹ í˜¸
      }
    },
    prepare: (element) => {
      prepareOutgoing(element);
      element.style.opacity = "0"; // ë³µì œë³¸ì€ ìˆ¨ê¹€
    },
  };
},
```

## 9. ê²°ë¡ 

SSGOIì˜ Element Cloning ë©”ì»¤ë‹ˆì¦˜ì€ Reactì˜ ì»´í¬ë„ŒíŠ¸ ë¼ì´í”„ì‚¬ì´í´ì„ êµë¬˜í•˜ê²Œ í™œìš©í•œ í˜ì‹ ì ì¸ í•´ê²°ì±…ì…ë‹ˆë‹¤:

1. **React ref cleanup íƒ€ì´ë° í™œìš©**: DOM ì œê±° ì§ì „ ìˆœê°„ì„ í¬ì°©
2. **ì™„ì „í•œ ìš”ì†Œ ë³µì œ**: `cloneNode(true)`ë¡œ ëª¨ë“  ìƒíƒœ ë³´ì¡´  
3. **ë…ë¦½ì  ì• ë‹ˆë©”ì´ì…˜**: ë³µì œë³¸ê³¼ ìƒˆ í˜ì´ì§€ì˜ ë™ì‹œ ì• ë‹ˆë©”ì´ì…˜
4. **ìë™ ì •ë¦¬**: ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ë³µì œë³¸ ì œê±°

ì´ë¥¼ í†µí•´ React Routerì˜ ì¦‰ê°ì ì¸ í˜ì´ì§€ ì „í™˜ì„ ìì—°ìŠ¤ëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ ì „í™˜ìœ¼ë¡œ ë°”ê¿”ì£¼ë©°, ë„¤ì´í‹°ë¸Œ ì•± ìˆ˜ì¤€ì˜ ì‚¬ìš©ì ê²½í—˜ì„ ì›¹ì—ì„œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**í•µì‹¬**: "ì‚¬ë¼ì§ˆ ê²ƒì„ ë¯¸ë¦¬ ë³µì œí•´ì„œ ë³´ì¡´í•˜ê³ , ë³µì œë³¸ìœ¼ë¡œ ì• ë‹ˆë©”ì´ì…˜í•œë‹¤"